# Copyright © 2004, The AROS Development Team. All rights reserved.
# $Id: mmakefile.src 28659 2008-05-10 20:49:16Z sszymczy $

-include $(TOP)/config/make.cfg

##MM- contrib-gnu : contrib-gnu-automake
#MM- contrib-gnu-automake : development-automake


#MM- development : development-automake



GNU_REPOSITORY := gnu://


#MM- development-automake-quick : development-automake--quick
#MM- development-automake--quick : development-automake--fetch
#MM- development-automake-fetch : development-automake--fetch
 
development-automake-archbase  := automake-1.9.6

ifeq (target,host)
    development-automake-portdir  := $(HOSTDIR)/Ports/automake
else
    development-automake-portdir  := $(PORTSDIR)/automake
endif

ifeq ($(AROS_DEVELOPMENT),)
    development-automake-prefix := $(CONTRIB_DIR)/automake
else
    development-automake-prefix := $(AROS_DEVELOPMENT)
endif

ifneq (,)
    development-automake--archbase  := automake--1.9.6
else
    development-automake--archbase  := automake-1.9.6
endif

ifneq (,)
    development-automake--srcdir  := 
else
    development-automake--srcdir  := $(development-automake-archbase)
endif

ifeq (no,yes)
    development-automake--patches_specs := $(development-automake--archbase)-aros.diff:$(development-automake--srcdir):-p1    
else
    development-automake--patches_specs := ::
endif

.PHONY : development-automake--fetch
#MM
development-automake--fetch :
	$(FETCH) -ao ".  $(GNU_REPOSITORY)automake" -a $(development-automake--archbase) -s "tar.bz2 tar.gz" -l $(PORTSSOURCEDIR) -d $(development-automake-portdir) \
        -po ". " -p $(development-automake--patches_specs)

#MM- development-automake : development-automake-

development-automake--package-dir := $(development-automake-portdir)/$(development-automake--archbase)

development-automake--package-basename := \
    $(DISTDIR)/Packages/$(development-automake--archbase)-aros.$(AROS_TARGET_CPU)


ifneq ($(development-automake-prefix),)
    development-automake--prefix := $(development-automake-prefix)
else
    development-automake--prefix := $(AROS_CONTRIB)
endif

ifneq (/Development,)
    development-automake--aros_prefix := /Development
else
    development-automake--aros_prefix := $(development-automake--prefix)
endif

ifeq (yes,yes)
    development-automake--nix    := -nix
    development-automake--volpfx := /
    development-automake--volsfx := /
    
    ifeq (,)
        development-automake--nix_dir_layout := yes
    endif
else
    development-automake--volsfx := :
    
    ifeq (,)
        development-automake--nix_dir_layout := no
    endif
endif

development-automake--volfunc = $(development-automake--volpfx)$(notdir $1)$(development-automake--volsfx)

development-automake--install_opts := prefix=$(development-automake--prefix) \
	exec_prefix=$(development-automake--prefix) 

# Check if chosen compiler is valid
ifeq ($(findstring target,host target kernel),)
  $(error unknown compiler target)
endif

# Set legacy 'host' variable based on chosen compiler
ifeq (target,host)
    host := yes
	ifeq (automake,)
		development-automake--pkgdir := $(HOSTGENDIR)/$(CURDIR)
	else
		development-automake--pkgdir := $(HOSTGENDIR)/$(CURDIR)/automake
	endif
else
    host := no
	ifeq (automake,)
		development-automake--pkgdir := $(GENDIR)/$(CURDIR)
	else
		development-automake--pkgdir := $(GENDIR)/$(CURDIR)/automake
	endif
endif

development-automake--configflag := $(development-automake--pkgdir)/.configured
development-automake--installflag := $(development-automake--pkgdir)/.installed

ifeq ($(filter yes, $(development-automake--nix_dir_layout) $(host)),yes)
    development-automake--PROGDIR      := $(development-automake--aros_prefix)/bin
    development-automake--config_opts  := --prefix=$(development-automake--aros_prefix)
else
    ifeq (yes,yes)
        development-automake--config_opts := --prefix=/PROGDIR  --bindir=/PROGDIR --sbindir=/PROGDIR \
        --libdir=/LIB --includedir=/INCLUDE --oldincludedir=/INCLUDE   
    else
        development-automake--config_opts  := --prefix=$(development-automake--aros_prefix)
    endif

    development-automake--PROGDIR := $(development-automake--aros_prefix)
    
    development-automake--install_opts := bindir=$(development-automake--prefix) \
	sbindir=$(development-automake--prefix) \
	libdir=$(AROS_LIB) includedir=$(AROS_INCLUDES) \
	oldincludedir=$(AROS_INCLUDES) 
endif


.PHONY : development-automake- development-automake--clean development-automake--build_and_install-quick

#MM- development-automake- : setup includes linklibs-core development-automake--quick

ifneq (install,)
    development-automake--install_command = \
        $(MAKE) PROGDIR="$(development-automake--PROGDIR)/" $(development-automake--install_opts) \
        -C $(development-automake--pkgdir) install && \
        $(TOUCH) $(development-automake--installflag)

    development-automake--uninstall_command = \
    $(RM) $(development-automake--installflag) && \
    $(MAKE) PROGDIR="$(development-automake--PROGDIR)/" $(development-automake--install_opts) \
    -C $(development-automake--pkgdir) uninstall
else
    development-automake--install_command   := true
    development-automake--uninstall_command := true
endif

#MM- development-automake--quick : development-automake--configure  development-automake--build_and_install-quick       development-automake--make-package

#MM
development-automake--build_and_install-quick :  $(development-automake--configflag)
	if ! $(MAKE) PROGDIR="$(call development-automake--volfunc, PROGDIR)" -q -C $(development-automake--pkgdir); then \
            $(RM)  $(development-automake--installflag) && \
	    $(MAKE) PROGDIR="$(call development-automake--volfunc, PROGDIR)" -C $(development-automake--pkgdir) && \
	    $(development-automake--install_command); \
        fi

$(development-automake-portdir)/$(development-automake--srcdir)/.files-touched:
	find $(development-automake-portdir)/$(development-automake--srcdir) -exec $(TOUCH) -r $(development-automake-portdir)/$(development-automake--srcdir)/configure '{}' \; && \
	$(TOUCH) $@

#MM
development-automake--uninstall :
	$(development-automake--uninstall_command)

ifneq ($(DEBUG),yes)
    development-automake--s_flag = -s
endif

#MM
development-automake--configure : $(development-automake--configflag)

ifeq (target,host)
$(development-automake--configflag) : $(development-automake-portdir)/$(development-automake--srcdir)/.files-touched $(TOP)/$(CURDIR)/mmakefile
	$(RM) $@ 
	@$(FOR) dir in $(development-automake--pkgdir) ; do \
	    $(IF) $(TEST) ! -d $$dir ; then $(MKDIR) $$dir ; else $(NOP) ; fi ; \
	done
	cd $(development-automake--pkgdir) && \
	find . -name config.cache -exec $(RM) '{}' \; && \
	CC="$(HOST_CC)" \
	    $(development-automake-portdir)/$(development-automake--srcdir)/configure $(development-automake--config_opts)  && \
	    $(TOUCH) $@
endif
ifeq (target,target)
$(development-automake--configflag) : $(development-automake-portdir)/$(development-automake--srcdir)/.files-touched $(TOP)/$(CURDIR)/mmakefile
	$(RM) $@
	@$(FOR) dir in $(development-automake--pkgdir) ; do \
	    $(IF) $(TEST) ! -d $$dir ; then $(MKDIR) $$dir ; else $(NOP) ; fi ; \
	done
	cd $(development-automake--pkgdir) && \
	find . -name config.cache -exec $(RM) '{}' \; && \
	CC="$(TARGET_CC) $(development-automake--nix) $(development-automake--s_flag)" \
	    AS="$(TARGET_AS)" CC_FOR_BUILD="$(HOST_CC)" RANLIB="$(RANLIB)" \
	    $(development-automake-portdir)/$(development-automake--srcdir)/configure $(development-automake--config_opts)  \
	    --build=$(AROS_HOST_CPU)-$(AROS_HOST_ARCH) \
	    --host=$(AROS_TARGET_CPU)-aros \
	    --target=$(AROS_TARGET_CPU)-aros \
	    --disable-nls \
	    --without-x --without-pic --disable-shared && \
	    $(TOUCH) $@
endif
ifeq (target,kernel)
$(development-automake--configflag) : $(development-automake-portdir)/$(development-automake--srcdir)/.files-touched $(TOP)/$(CURDIR)/mmakefile
	$(RM) $@
	@$(FOR) dir in $(development-automake--pkgdir) ; do \
	    $(IF) $(TEST) ! -d $$dir ; then $(MKDIR) $$dir ; else $(NOP) ; fi ; \
	done
	cd $(development-automake--pkgdir) && \
	find . -name config.cache -exec $(RM) '{}' \; && \
	CC="$(KERNEL_CC) $(KERNEL_CFLAGS) $(development-automake--nix) $(development-automake--s_flag)" \
	    AS="$(TARGET_AS)" CC_FOR_BUILD="$(HOST_CC)" RANLIB="$(RANLIB)" \
	    $(development-automake-portdir)/$(development-automake--srcdir)/configure $(development-automake--config_opts)  \
	    --build=$(AROS_HOST_CPU)-$(AROS_HOST_ARCH) \
	    --host=$(AROS_TARGET_CPU)-aros \
	    --target=$(AROS_TARGET_CPU)-aros --disable-nls \
	    --without-x --without-pic --disable-shared && \
	    $(TOUCH) $@
endif
	
#MM
development-automake--clean : development-automake--uninstall
	@$(RM) $(development-automake--pkgdir)

.PHONY : development-automake--make-package
#MM development-automake--make-package : development-automake--quick

#MM
development-automake--make-package : $(development-automake--package-basename).tar.bz2
 
#There seems to be a bug, either with my clock or with make, 'cause it may happen
#that $^ and $@ have exactly the same mtime, and in that case make tries
#to rebuild $@ again, which would fail because the directory where
#the package got installed would not exist anymore. 
#We work this around by using an if statement to manually check the mtimes.
$(development-automake--package-basename).tar.bz2 :
	@$(IF) test $(development-automake-installflag) -nt $@ || ! test -f $@; then \
        $(RM) $@ ; \
        $(ECHO) "Building \`$(development-automake--package-basename).tar.bz2'" ; \
        mkdir -p "$(DISTDIR)/Packages" ; \
        mkdir -p "$(development-automake-prefix)" ; \
        cd $(development-automake--package-dir) ; \
        tar -cvf $(development-automake--package-basename).tar * ; \
        bzip2 -9 -f $(development-automake--package-basename).tar ; \
    fi

    

# Delete generated makefiles
#MM
clean ::
	@$(RM) $(TOP)/$(CURDIR)/mmakefile $(TOP)/$(CURDIR)/mmakefile.bak

include $(SRCDIR)/config/make.tail

BDID := $(BDTARGETID)
